import undetected_chromedriver as uc
from bs4 import BeautifulSoup
from urllib.parse import urljoin
import time
import datetime
import os
import random

# --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø§Ø¨Ø· ---
TARGET_URL = "https://coursatk.online/years"
OUTPUT_FILE = "index.html"

# --- ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ù†ØµØ© ---
HTML_TEMPLATE = """
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academy - Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…ÙÙƒÙˆÙƒ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {{ --primary: #7c3aed; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; }}
        body {{ font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; }}
        
        header {{ background: #111827; padding: 2rem; text-align: center; border-bottom: 4px solid var(--primary); }}
        header h1 {{ margin: 0; font-size: 2.5rem; color: var(--primary); text-transform: uppercase; }}
        header p {{ color: #9ca3af; margin-top: 10px; }}

        .container {{ max-width: 1000px; margin: 2rem auto; padding: 0 1rem; display: flex; flex-direction: column; gap: 20px; }}
        
        .section-title {{ color: #facc15; font-size: 1.5rem; margin-top: 2rem; border-right: 4px solid #facc15; padding-right: 10px; font-weight: bold; }}

        .card {{ background: var(--card); border-radius: 12px; overflow: hidden; border: 1px solid #374151; transition: 0.3s; display: flex; flex-direction: column; }}
        .card:hover {{ transform: translateY(-3px); border-color: var(--primary); }}
        
        .card-body {{ padding: 1.5rem; }}
        .card-title {{ margin: 0 0 10px 0; font-size: 1.1rem; font-weight: bold; color: white; }}
        
        .btn {{ display: inline-flex; align-items: center; gap: 8px; background: var(--primary); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600; margin-top: 10px; }}
        .btn:hover {{ background: #6d28d9; }}
    </style>
</head>
<body>
    <header>
        <h1><i class="fas fa-mask"></i> ACADEMY STEALTH</h1>
        <p>ØªÙ… Ø§Ø®ØªØ±Ø§Ù‚ Ø§Ù„Ø­Ù…Ø§ÙŠØ© ÙˆØ³Ø­Ø¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</p>
        <div style="font-size: 0.8rem; color: #6b7280;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: {date}</div>
    </header>

    <div class="container">
        {content}
    </div>
    
    <footer style="text-align: center; padding: 2rem; color: #4b5563;">Generated by Stealth Scraper</footer>
</body>
</html>
"""

def bypass_and_scrape():
    print("ğŸš€ Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ø´Ø¨Ø­ (Stealth Mode)...")
    
    # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ®ÙÙŠ
    options = uc.ChromeOptions()
    options.add_argument('--headless=new')  # ÙˆØ¶Ø¹ Ø§Ù„ØªØ®ÙÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    options.add_argument('--no-sandbox')
    options.add_argument('--disable-dev-shm-usage')
    options.add_argument('--disable-blink-features=AutomationControlled') # Ø¥Ø®ÙØ§Ø¡ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø±ÙˆØ¨ÙˆØª
    
    # ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ØªØµÙØ­
    driver = uc.Chrome(options=options, version_main=None)

    try:
        print(f"ğŸ•µï¸â€â™‚ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ù„Ù„ Ø¥Ù„Ù‰: {TARGET_URL}")
        driver.get(TARGET_URL)
        
        # Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ø¹Ø´Ø§Ù† ØµÙØ­Ø© Ø§Ù„Ø­Ù…Ø§ÙŠØ© ØªØ®ØªÙÙŠ)
        print("â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø¹Ø¨ÙˆØ± Ø¨ÙˆØ§Ø¨Ø© Cloudflare...")
        time.sleep(15)  # Ø§Ù†ØªØ¸Ø§Ø± 15 Ø«Ø§Ù†ÙŠØ© ÙƒØ§Ù…Ù„Ø©
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù‡Ù„ Ø¹Ø¯ÙŠÙ†Ø§ ÙˆÙ„Ø§ Ù„Ø³Ù‡ØŸ
        title = driver.title
        print(f"ğŸ“„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: {title}")
        
        if "Just a moment" in title or "Cloudflare" in title:
            print("âš ï¸ Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ù„Ø³Ù‡ Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ù‡Ù†Ø³ØªÙ†Ù‰ 10 Ø«ÙˆØ§Ù†ÙŠ ÙƒÙ…Ø§Ù†...")
            time.sleep(10)
        
        # Ø³Ø­Ø¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø¨ÙˆØ±
        page_source = driver.page_source
        soup = BeautifulSoup(page_source, 'html.parser')
        
        html_content = ""
        count = 0
        seen_urls = set()

        # ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± (Ù„ÙŠÙ†ÙƒØ§Øª - ØµÙˆØ± - ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª)
        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒÙ„ Ø­Ø§Ø¬Ø© Ù…Ù…ÙƒÙ†Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø©
        main_body = soup.find('body')
        
        if main_body:
            for element in main_body.find_all(['a', 'h1', 'h2', 'h3', 'video', 'div']):
                
                # Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† (Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø£Ùˆ Ø§Ù„Ø³Ù†ÙŠÙ†)
                if element.name in ['h1', 'h2', 'h3'] and element.text.strip():
                    text = element.text.strip()
                    # ÙÙ„ØªØ±Ø© Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©
                    if len(text) > 3 and "Cloudflare" not in text:
                         html_content += f'<div class="section-title">{text}</div>'

                # Ø§Ù„Ø±ÙˆØ§Ø¨Ø· (Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª)
                if element.name == 'a':
                    href = element.get('href')
                    text = element.text.strip()
                    
                    if href and href not in seen_urls and not href.startswith("#"):
                        full_url = urljoin(TARGET_URL, href)
                        
                        # Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø±ÙˆØ§Ø¨Ø· ÙƒÙ„Ø§ÙˆØ¯ ÙÙ„ÙŠØ± ÙˆØ±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù†ÙØ³Ù‡
                        if "cloudflare" in full_url or "coursatk.online" == full_url:
                            continue

                        seen_urls.add(href)
                        count += 1
                        
                        # ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø±Ø§Ø¨Ø·
                        icon = "fa-link"
                        if any(x in full_url for x in ['.pdf', 'drive', 'upload']): icon = "fa-file-arrow-down"
                        if any(x in full_url for x in ['.mp4', 'video', 'watch']): icon = "fa-video"
                        
                        html_content += f"""
                        <div class="card">
                            <div class="card-body">
                                <h3 class="card-title"><i class="fas {icon}"></i> {text if text else 'Ø±Ø§Ø¨Ø· Ù…Ø­ØªÙˆÙ‰'}</h3>
                                <a href="{full_url}" class="btn" target="_blank">ÙØªØ­ / ØªØ­Ù…ÙŠÙ„</a>
                            </div>
                        </div>
                        """
        
        if count == 0:
            html_content = f"""
            <div style='text-align:center; padding:50px; color:#ef4444;'>
                <h3>âš ï¸ Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±ÙˆØ§Ø¨Ø· Ù…ÙÙŠØ¯Ø©.</h3>
                <p>ÙŠØ¨Ø¯Ùˆ Ø£Ù† Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ù†Ø¹ØªÙ†Ø§ØŒ Ø£Ùˆ Ø£Ù† Ø§Ù„ØµÙØ­Ø© ÙØ§Ø±ØºØ©.</p>
                <p>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªÙŠ ÙˆØµÙ„Ù†Ø§ Ù„Ù‡Ø§: {driver.title}</p>
            </div>
            """

        # Ø§Ù„Ø­ÙØ¸
        final_html = HTML_TEMPLATE.format(content=html_content, date=datetime.datetime.now())
        with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
            f.write(final_html)
            
        print(f"âœ… ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©! ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ {count} Ø¹Ù†ØµØ±.")

    except Exception as e:
        print(f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙƒØ¨ÙŠØ±: {e}")
    finally:
        driver.quit()

if __name__ == "__main__":
    bypass_and_scrape()
